<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Taxas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { font-family: sans-serif; background: #f4f4f4; padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* Estilo da Logo */
        .logo-container { text-align: center; margin-bottom: 15px; }
        .logo-img { max-width: 150px; height: auto; }

        h2 { text-align: center; color: #007bff; margin-bottom: 5px; }
        .cidade-txt { text-align: center; color: #666; font-size: 0.9em; margin-bottom: 20px; }
        label { display: block; margin-bottom: 10px; font-weight: bold; }
        input { width: 100%; padding: 15px; font-size: 1.2em; border: 2px solid #007bff; border-radius: 8px; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; margin-top: 25px; }
        th, td { border-bottom: 1px solid #eee; padding: 12px; text-align: left; }
        th { background: #f8f9fa; color: #333; }
        .val-total { font-weight: bold; color: #007bff; }
        
        /* Bot√£o WhatsApp com √çcone */
        .btn-whats { display: flex; align-items: center; justify-content: center; gap: 10px; background: #25d366; color: white; text-align: center; padding: 18px; text-decoration: none; border-radius: 8px; font-weight: bold; margin-top: 25px; font-size: 1.1em; transition: 0.3s; }
        .btn-whats:hover { background: #1ebe57; transform: scale(1.02); }
        .fa-whatsapp { font-size: 1.4em; }
    </style>
</head>
<body>

<div class="container">
    <div class="logo-container">
        <img src="logo.jpg" alt="Logo" class="logo-img">
    </div>

    <h2 id="nomeRep">Carregando...</h2>
    <div id="cidadeRep" class="cidade-txt"></div>

    <label>Valor que deseja receber (L√≠quido):</label>
    <input type="number" id="valorInput" value="1000.00" oninput="calcular()">

    <table id="tabelaTaxas">
        <thead>
            <tr>
                <th>Parcelas</th>
                <th>Total a Cobrar</th>
                <th>Valor Parcela</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <a href="#" id="linkWhats" target="_blank" class="btn-whats">
        <i class="fab fa-whatsapp"></i> VALIDAR E FECHAR PROPOSTA
    </a>
</div>

<script>
    // CR√çTICO: Esta fun√ß√£o l√™ o ID do representante diretamente do nome do arquivo (ex: rep_5.html -> 5).
    function extrairIdDoFileName() {
        const path = window.location.pathname;
        const fileName = path.substring(path.lastIndexOf('/') + 1); 
        const match = fileName.match(/rep_(\d+)\.html/i);
        return match ? parseInt(match[1]) : 1; 
    }
    
    // O ID agora √© din√¢mico!
    const REPRESENTANTE_ID = extrairIdDoFileName(); 
    
    // URL DO SEU GOOGLE APPS SCRIPT
    const API_URL = 'https://script.google.com/macros/s/AKfycbx_kZOvD2vxIRKZkCJCdnmx2-bN4ee1Z-95FJuyImXHKYai2rdNadz_cjQLIMgZCigN/exec';
    let dadosRep = {};

    // Fun√ß√£o auxiliar para formatar dinheiro no texto
    const formatarDinheiro = (valor) => `R$ ${valor.toFixed(2).replace('.',',')}`;

    async function buscarDados() {
        try {
            const resp = await fetch(API_URL);
            const todos = await resp.json();
            // Busca o representante com o ID din√¢mico
            dadosRep = todos.find(r => r.RepId == REPRESENTANTE_ID);
            
            if(dadosRep) {
                document.getElementById('nomeRep').innerText = dadosRep.Nome || `Representante ${REPRESENTANTE_ID}`;
                document.getElementById('cidadeRep').innerText = dadosRep.Cidade || "";
                calcular();
            } else {
                 document.getElementById('nomeRep').innerText = `Representante ${REPRESENTANTE_ID} - Dados N√£o Encontrados`;
            }
        } catch (e) { document.getElementById('nomeRep').innerText = "Erro ao carregar taxas"; }
    }

    function calcular() {
        if(!dadosRep.Nome) return;
        
        const liquido = parseFloat(document.getElementById('valorInput').value) || 0;
        const plano = dadosRep.PlanoAtivo || 1;
        const tbody = document.querySelector('#tabelaTaxas tbody');
        tbody.innerHTML = '';
        
        const parcelas = ['debito', '1x', '2x', '3x', '4x', '5x', '6x', '7x', '8x', '9x', '10x', '11x', '12x', '13x', '14x', '15x', '16x', '17x', '18x'];

        // Gera√ß√£o da Tabela de Texto para o WhatsApp
        let tabelaTexto = `*Simula√ß√£o de Taxas (Valor L√≠quido: ${formatarDinheiro(liquido)})*\n\n`;
        tabelaTexto += "üìä *RESUMO DA PROPOSTA:*\n";
        tabelaTexto += "--------------------------------------\n";

        parcelas.forEach(p => {
            // Garante que a chave da coluna √© sempre com "X" mai√∫sculo (1X_1)
            const coluna = p === 'debito' ? `Debito_${plano}` : `${p.toUpperCase()}_${plano}`;
            const taxa = parseFloat(dadosRep[coluna]) || 0;

            // C√ÅLCULO MARKUP (ACR√âSCIMO SIMPLES): ValorTotal = Liquido * (1 + Taxa/100)
            const total = liquido * (1 + (taxa / 100));
            const numParcelas = p.includes('x') ? parseInt(p) : 1;
            const vParcela = total / numParcelas;

            if(taxa > 0 || p === 'debito') {
                // 1. Atualiza a tabela HTML
                tbody.innerHTML += `<tr>
                    <td>${p === 'debito' ? 'D√©bito' : p}</td>
                    <td class="val-total">${formatarDinheiro(total)}</td>
                    <td>${numParcelas}x ${formatarDinheiro(vParcela)}</td>
                </tr>`;

                // 2. Constr√≥i a linha da tabela de texto para o WhatsApp
                const modalidade = p === 'debito' ? 'D√©bito' : `${numParcelas}x (Cr√©dito)`;
                const totalFormatado = formatarDinheiro(total);
                const parcelaFormatada = formatarDinheiro(vParcela);

                tabelaTexto += `*${modalidade}:* ${totalFormatado}\n`;
                tabelaTexto += `  - Parcelas: ${numParcelas}x de ${parcelaFormatada}\n`;
            }
        });

        tabelaTexto += "--------------------------------------\n";
        
        // Frase de fechamento
        const mensagemBase = `Ol√°, ${dadosRep.Nome} de ${dadosRep.Cidade}! 
        
Acabei de gerar uma simula√ß√£o de taxas na sua p√°gina. Por favor, valide os valores abaixo para que possamos fechar a proposta hoje!`;
        
        // Combina a mensagem base com a tabela de texto
        const msgWhats = `${mensagemBase}\n\n${tabelaTexto}\n`;

        // Atribui a mensagem formatada para a URL do WhatsApp
        document.getElementById('linkWhats').href = `https://wa.me/${dadosRep.Whatsapp}?text=${encodeURIComponent(msgWhats)}`;
    }
    window.onload = buscarDados;
</script>
</body>
</html>
