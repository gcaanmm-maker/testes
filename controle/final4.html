<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de Ferramentas</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body { font-family: Arial; margin:0; background:#f0f2f5; }
header { background:#007bff; color:white; padding:15px; text-align:center; font-size:20px; }
nav { display:flex; justify-content:space-around; background:#0056b3; }
nav button { flex:1; padding:12px; border:none; background:#0056b3; color:white; font-size:16px; cursor:pointer; }
nav button:hover { background:#003f7f; }
.container { padding:10px; }
.card { background:white; padding:15px; margin:15px 0; border-radius:15px; box-shadow:0 2px 5px rgba(0,0,0,0.2); border-left:6px solid #007bff; }
.card img { max-width:100%; margin-top:10px; border-radius:10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
.faltando { color:red; font-weight:bold; font-size:16px; margin-top:5px; }
ul { padding-left:20px; }
button { padding:8px 15px; border-radius:8px; margin-top:5px; cursor:pointer; }
input, select { width:100%; padding:8px; margin:5px 0; border-radius:5px; border:1px solid #ccc; }
.hidden { display:none; }
video { border-radius:10px; margin-top:10px; width:100%; max-width:300px; }
#previewFoto { width:100%; max-width:300px; margin-top:10px; display:block; border:2px solid green; border-radius:10px; }
#confirmFoto { color:green; font-weight:bold; display:none; }
li button { margin-left:10px; }
table { border-collapse: collapse; width: 100%; margin-top: 5px; }
th, td { border: 1px solid #b3d9ff; padding: 6px; text-align: left; }
th { background-color: #cce6ff; }
tr:nth-child(even){background-color: #e6f2ff;}
.divisoria { height: 2px; background: linear-gradient(to right, #007bff, #66b3ff, transparent); margin: 20px 0; border-radius: 2px; }
</style>
</head>
<body>
<header>Controle de Ferramentas</header>

<nav>
  <button onclick="mostrarTela('checklist')">Checklist</button>
  <button onclick="mostrarTela('ferramentas')">Ferramentas</button>
  <button onclick="mostrarTela('relatorios')">Relat√≥rios</button>
  <button onclick="mostrarTela('usuarios')">Usu√°rios</button>
</nav>

<div class="container">
  <!-- Checklist -->
  <div id="checklist" class="hidden">
    <h2>Checklist Di√°rio</h2>
    <label for="responsavel">Respons√°vel:</label>
    <select id="responsavel"><option value="">Carregando...</option></select>

    <div id="listaFerramentas"></div>

    <h3>Foto do Arm√°rio</h3>
    <video id="video" autoplay></video>
    <button onclick="tirarFoto()">Tirar Foto do Arm√°rio</button>
    <canvas id="canvas" width="300" height="200" style="display:none;"></canvas>
    <p id="confirmFoto">‚úÖ Foto tirada!</p>
    <img id="previewFoto"/>

    <button onclick="finalizarChecklist()">Finalizar Checklist</button>
  </div>

  <!-- Ferramentas -->
  <div id="ferramentas" class="hidden">
    <h2>Adicionar Ferramenta</h2>
    <input type="text" id="nomeFerramenta" placeholder="Nome da ferramenta">
    <input type="text" id="descricaoFerramenta" placeholder="Descri√ß√£o (opcional)">
    <input type="text" id="localizacaoFerramenta" placeholder="Localiza√ß√£o (opcional)">
    <button onclick="adicionarFerramenta()">Adicionar</button>
    <h3>Lista de Ferramentas</h3>
    <ul id="listaFerramentasCadastradas"></ul>
  </div>

  <!-- Relat√≥rios -->
  <div id="relatorios" class="hidden">
    <h2>Relat√≥rios</h2>
    <button onclick="carregarRelatorios()">üîÑ Atualizar Relat√≥rios</button>
    <div id="cardsRelatorios">Carregando...</div>
  </div>

  <!-- Usu√°rios -->
  <div id="usuarios" class="hidden">
    <h2>Gerenciar Usu√°rios</h2>
    <h3>Adicionar Usu√°rio</h3>
    <input type="text" id="nomeUsuario" placeholder="Nome do usu√°rio">
    <button onclick="adicionarUsuario()">Adicionar</button>

    <h3>Lista de Usu√°rios</h3>
    <ul id="listaUsuarios">Carregando...</ul>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabaseUrl = 'https://jyehccjogujkdtingplc.supabase.co';
const supabaseKey = 'SEU_SUPABASE_KEY';
const supabase = createClient(supabaseUrl, supabaseKey);

let ferramentas = [];
let usuarios = [];
let fotoArmarioFile = null;
let cameraAtiva = false;

// Navega√ß√£o
window.mostrarTela = function(id){
  ['checklist','ferramentas','relatorios','usuarios'].forEach(t => document.getElementById(t).classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  if(id==='checklist') carregarChecklist();
  if(id==='ferramentas') carregarFerramentas();
  if(id==='relatorios') carregarRelatorios();
  if(id==='usuarios') carregarUsuarios();
};

// Fun√ß√£o Data/Hora
function getDataHoraBrasiliaISO() {
  const agora = new Date();
  const opcoes = { timeZone: 'America/Sao_Paulo' };
  const ano = agora.toLocaleString('en-CA', { ...opcoes, year:'numeric' });
  const mes = agora.toLocaleString('en-CA', { ...opcoes, month:'2-digit' });
  const dia = agora.toLocaleString('en-CA', { ...opcoes, day:'2-digit' });
  const hora = agora.toLocaleString('en-CA', { ...opcoes, hour:'2-digit', hour12:false });
  const minuto = agora.toLocaleString('en-CA', { ...opcoes, minute:'2-digit' });
  const segundo = agora.toLocaleString('en-CA', { ...opcoes, second:'2-digit' });
  return `${ano}-${mes}-${dia}T${hora}:${minuto}:${segundo}`;
}

// ========== Usu√°rios ==========
async function carregarUsuarios(){
  if(usuarios.length>0) return;
  const { data, error } = await supabase.from('usuarios').select('*').order('nome');
  if(error) return alert('Erro: '+error.message);
  usuarios = data || [];
  const select = document.getElementById('responsavel');
  select.innerHTML='<option value="">Selecione o respons√°vel</option>';
  usuarios.forEach(u=>{
    const option=document.createElement('option'); option.value=u.nome; option.textContent=u.nome; select.appendChild(option);
  });
  const ul=document.getElementById('listaUsuarios'); ul.innerHTML='';
  if(usuarios.length===0){ ul.textContent='Nenhum usu√°rio cadastrado.'; return; }
  usuarios.forEach(u=>{
    const li=document.createElement('li'); li.textContent=u.nome;
    const btn=document.createElement('button'); btn.textContent='Remover'; btn.onclick=()=>removerUsuario(u.id);
    li.appendChild(btn); ul.appendChild(li);
  });
}

async function adicionarUsuario(){
  const senha = prompt('Informe a senha para adicionar usu√°rio:');
  if(senha !== 'Qaz123..') return alert('Senha incorreta!');
  const nome = document.getElementById('nomeUsuario').value.trim();
  if(!nome) return alert('Digite o nome do usu√°rio');
  const { error } = await supabase.from('usuarios').insert([{ nome }]);
  if(error) return alert('Erro: '+error.message);
  alert('Usu√°rio adicionado com sucesso!'); document.getElementById('nomeUsuario').value='';
  usuarios=[]; carregarUsuarios();
}

async function removerUsuario(id){
  const senha = prompt('Informe a senha para remover usu√°rio:');
  if(senha !== 'Qaz123..') return alert('Senha incorreta!');
  if(!confirm('Tem certeza que deseja remover este usu√°rio?')) return;
  const { error } = await supabase.from('usuarios').delete().eq('id', id);
  if(error) return alert('Erro: '+error.message);
  alert('Usu√°rio removido!'); usuarios=[]; carregarUsuarios();
}

// ========== Ferramentas ==========
async function carregarFerramentas(){
  const { data, error } = await supabase.from('ferramentas').select('*').order('nome');
  if(error) return alert('Erro: '+error.message);
  ferramentas = data || [];
  const ul = document.getElementById('listaFerramentasCadastradas'); ul.innerHTML='';
  ferramentas.forEach(f=>{
    const li=document.createElement('li'); li.textContent=f.nome+(f.descricao?' - '+f.descricao:'');
    const btn=document.createElement('button'); btn.textContent='Remover';
    btn.onclick=async()=>{
      const senha = prompt('Informe a senha para remover a ferramenta:');
      if(senha!=='Qaz123..') return alert('Senha incorreta!');
      if(confirm('Deseja remover esta ferramenta?')){
        await supabase.from('ferramentas').delete().eq('id',f.id); carregarFerramentas();
      }
    };
    li.appendChild(btn); ul.appendChild(li);
  });
}

async function adicionarFerramenta(){
  const nome=document.getElementById('nomeFerramenta').value;
  const desc=document.getElementById('descricaoFerramenta').value;
  const loc=document.getElementById('localizacaoFerramenta').value;
  if(!nome) return alert('Digite o nome da ferramenta');
  const { error } = await supabase.from('ferramentas').insert([{nome, descricao:desc, localizacao:loc}]);
  if(error) return alert('Erro: '+error.message);
  document.getElementById('nomeFerramenta').value=''; document.getElementById('descricaoFerramenta').value=''; document.getElementById('localizacaoFerramenta').value='';
  carregarFerramentas();
}

// ========== Checklist ==========
async function carregarChecklist(){
  await carregarUsuarios();
  const container=document.getElementById('listaFerramentas'); container.innerHTML='';
  if(ferramentas.length===0) await carregarFerramentas();
  ferramentas.forEach(f=>{
    const div=document.createElement('div');
    div.innerHTML=`<input type="checkbox" id="f${f.id}" data-id="${f.id}"> <label for="f${f.id}">${f.nome}</label>`;
    container.appendChild(div);
  });
  if(!cameraAtiva){
    cameraAtiva=true;
    const video=document.getElementById('video');
    navigator.mediaDevices.getUserMedia({video:true}).then(stream=>video.srcObject=stream).catch(err=>console.error(err));
  }
}

window.tirarFoto=function(){
  const video=document.getElementById('video'); const canvas=document.getElementById('canvas');
  const ctx=canvas.getContext('2d'); ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const dataURL=canvas.toDataURL('image/png');
  fetch(dataURL).then(r=>r.blob()).then(blob=>{
    fotoArmarioFile=new File([blob],`foto_${Date.now()}.png`,{type:'image/png'});
    document.getElementById('previewFoto').src=dataURL;
    document.getElementById('confirmFoto').style.display='block';
  });
};

window.finalizarChecklist=async function(){
  const responsavel=document.getElementById('responsavel').value; if(!responsavel) return alert('Selecione o respons√°vel');
  const dataLocal=getDataHoraBrasiliaISO();
  const { data: ckInsert, error: ckError } = await supabase.from('checklists').insert([{data:dataLocal,responsavel}]).select('*');
  if(ckError) return alert('Erro ao salvar checklist: '+ckError.message);
  const checklistId=ckInsert[0].id;
  const checkeds=document.querySelectorAll('#listaFerramentas input[type=checkbox]');
  for(const cb of checkeds){
    if(cb.checked){
      await supabase.from('checklist_itens').insert([{checklist_id:checklistId,ferramenta_id:cb.dataset.id}]);
    }
  }
  if(fotoArmarioFile){
    const { data: uploadData, error: upError } = await supabase.storage.from('checklist').upload(`fotos/${fotoArmarioFile.name}`, fotoArmarioFile);
    if(upError) console.error(upError);
  }
  alert('Checklist finalizado e salvo com sucesso!');
};

// ========== Relat√≥rios ==========
async function carregarRelatorios(){
  const { data: checklistData, error: cError } = await supabase.from('checklists').select('*,itens:checklist_itens(ferramenta_id(*))').order('data', { ascending:false });
  if(cError) return alert('Erro ao carregar relat√≥rios: '+cError.message);
  const cards=document.getElementById('cardsRelatorios'); cards.innerHTML='';
  if(!checklistData || checklistData.length===0){ cards.textContent='Nenhum checklist encontrado.'; return; }
  checklistData.forEach(c=>{
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`<strong>${c.responsavel}</strong> - ${new Date(c.data).toLocaleString('pt-BR')}<div class="divisoria"></div>`;
    const ul=document.createElement('ul');
    if(c.itens && c.itens.length>0){
      c.itens.forEach(i=>{ ul.innerHTML+=`<li>${i.ferramenta_id.nome}</li>`; });
    }else{ ul.innerHTML='<li class="faltando">Nenhuma ferramenta marcada</li>'; }
    card.appendChild(ul);
    cards.appendChild(card);
  });
}
</script>
</body>
</html>
