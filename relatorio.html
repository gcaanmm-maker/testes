<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Exportar Lojas e Leituras</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;background:#f7f9fb;margin:0;padding:20px;color:#222}
header{background:#0d6efd;color:#fff;padding:16px;border-radius:8px}
h1{margin:0;font-size:1.2rem}
.container{max-width:1100px;margin:18px auto}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:6px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.08)}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:0.95rem}
th{background:#f1f5f9}
.small{font-size:0.9rem;color:#555}
.msg{margin-top:8px;font-weight:600}
button{background:#0d6efd;color:#fff;border:0;padding:10px 12px;border-radius:8px;cursor:pointer}
button.secondary{background:#6c757d}
@media (max-width:800px){ th,td{font-size:0.85rem;padding:8px} .controls{flex-direction:column;align-items:stretch} }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
<header><h1>Exportar Lojas e Leituras</h1></header>

<div class="container">
  <div class="controls">
    <input id="filter" placeholder="Filtrar..." style="flex:1;padding:8px;border-radius:6px;border:1px solid #ccc" />
    <button id="btnRefresh">Atualizar</button>
    <button id="btnCSV">Baixar CSV</button>
    <button id="btnPDF">Baixar PDF</button>
    <button id="btnXLSX">Baixar XLSX</button>
    <button id="btnPrint" class="secondary">Imprimir</button>
  </div>

  <div id="msg" class="msg small">Aguardando atualização...</div>

  <div style="margin-top:12px;overflow:auto">
    <table id="tbl">
      <thead>
        <tr>
          <th>#</th>
          <th>Loja</th>
          <th>Medidor</th>
          <th>Leitura anterior</th>
          <th>Leitura atual</th>
          <th>Data/Hora</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
(async () => {
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxpGw31WXwSVg7Q8Z-cUmj-4X7PuWB0gKiBunDpqgZ_SA_2vJkqok8Ac4CoONunToE76A/exec";
  const tbody = document.getElementById('tbody');
  const msg = document.getElementById('msg');
  const filter = document.getElementById('filter');
  const btnRefresh = document.getElementById('btnRefresh');
  const btnCSV = document.getElementById('btnCSV');
  const btnPDF = document.getElementById('btnPDF');
  const btnXLSX = document.getElementById('btnXLSX');
  const btnPrint = document.getElementById('btnPrint');

  let data = [];

  function normalizeItem(item) {
    return {
      "Loja": item["Loja"] || item["loja"] || "",
      "Medidor": item["Medidor"] || item["medidor"] || "",
      "Leitura anterior": item["Leitura anterior"] || item["leitura_anterior"] || "",
      "Leitura atual": item["Leitura atual"] || item["leitura_atual"] || "",
      "Data/Hora": item["Data/Hora"] || item["data_hora"] || ""
    };
  }

  async function fetchData() {
    msg.textContent = "Carregando dados...";
    try {
      const r = await fetch(WEB_APP_URL);
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const json = await r.json();
      data = json.map(normalizeItem);
      renderTable(data);
      msg.textContent = `Dados carregados (${data.length})`;
    } catch(err) {
      console.error(err);
      msg.textContent = "Erro ao carregar dados: "+err.message;
      tbody.innerHTML="";
    }
  }

  function renderTable(list) {
    tbody.innerHTML = "";
    list.forEach((r,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td>
        <td>${r["Loja"]}</td>
        <td>${r["Medidor"]}</td>
        <td>${r["Leitura anterior"]}</td>
        <td>${r["Leitura atual"]}</td>
        <td>${r["Data/Hora"]}</td>`;
      tbody.appendChild(tr);
    });
  }

  filter.addEventListener('input',()=>{
    const t = filter.value.toLowerCase();
    renderTable(data.filter(r=>Object.values(r).some(v=>v.toLowerCase().includes(t))));
  });

  btnRefresh.addEventListener('click', fetchData);

  btnCSV.addEventListener('click',()=>{
    if(!data.length)return alert("Sem dados para exportar");
    const header = ["Loja","Medidor","Leitura anterior","Leitura atual","Data/Hora"];
    const rows = data.map(r=>[r["Loja"],r["Medidor"],r["Leitura anterior"],r["Leitura atual"],r["Data/Hora"]]);
    const csv = [header,...rows].map(r=>r.map(v=>`"${v}"`).join(",")).join("\r\n");
    const blob = new Blob([csv],{type:"text/csv;charset=utf-8"});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = "leituras.csv";
    document.body.appendChild(link);
    link.click();
    link.remove();
  });

  btnPDF.addEventListener('click',()=>{
    if(!data.length)return alert("Sem dados para exportar");
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:"mm",format:"a4"});
    doc.text("Lista de Lojas e Leituras",14,14);
    const rows = data.map((r,i)=>[i+1,r["Loja"],r["Medidor"],r["Leitura anterior"],r["Leitura atual"],r["Data/Hora"]]);
    doc.autoTable({head:[["#","Loja","Medidor","Leitura anterior","Leitura atual","Data/Hora"]],body:rows,startY:20,theme:"grid",styles:{fontSize:9}});
    doc.save("leituras.pdf");
  });

  btnXLSX.addEventListener('click',()=>{
    if(!data.length)return alert("Sem dados para exportar");
    const ws = XLSX.utils.json_to_sheet(data.map((r,i)=>({
      "#": i+1,
      "Loja": r["Loja"],
      "Medidor": r["Medidor"],
      "Leitura anterior": r["Leitura anterior"],
      "Leitura atual": r["Leitura atual"],
      "Data/Hora": r["Data/Hora"]
    })));
    ws['!cols']=[{wch:5},{wch:30},{wch:15},{wch:15},{wch:15},{wch:20}];
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Leituras");
    XLSX.writeFile(wb,"leituras.xlsx");
  });

  btnPrint.addEventListener('click',()=>window.print());

  await fetchData();
})();
</script>
</body>
</html>
